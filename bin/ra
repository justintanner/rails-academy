#!/bin/bash

# ra - A CLI tool for Rails Academy

function show_help() {
    echo "Usage: ra [command] [arguments]"
    echo ""
    echo "Commands:"
    echo "  verify              Verify your setup."
    echo "  skool @username     Register your skool username so that you can save you progress and more."
}

function please_reinstall_message() {
  echo "Please reinstall Rails Academy. Run the following command:"
  echo "curl -sSL https://rails.academy/install | bash"
  exit 1
}

function update_config() {
    local variable="$1"
    local value="$2"

    if grep -q "^export $variable=" "$CONFIG_FILE"; then
        # Update the variable if it exists
        sed -i '' "s|^export $variable=.*|export $variable=\"$value\"|" "$CONFIG_FILE"
    else
        # Add the variable if it doesn't exist
        echo "export $variable=\"$value\"" >> "$CONFIG_FILE"
    fi

    export $variable="$value"
    set +h

    echo "Updated $variable to \"$value\" in $CONFIG_FILE."
}

function verify() {
    echo "Verifying setup..."

    apps=("git" "gh" "mise" "kamal" "rails" "ruby" "docker" "grep")

    for app in "${apps[@]}"; do
        if ! command -v $app &> /dev/null; then
            echo "Error: $app is not installed."
            please_reinstall_message
        fi
    done

    if ! docker info &> /dev/null; then
        echo "Error: Docker is not running."
        echo "Please launch Docker and try again."
        exit 1
    fi
}

function skool() {
    if [ -z "$1" ]; then
        echo "Error: No username provided."
        echo "Usage: ra skool @username"
        exit 1
    fi

    echo "Launching skool for user $1..."
    update_config "RA_SKOOL_USERNAME" "$1"
}

if [ $# -eq 0 ]; then
    show_help
    exit 0
fi

case $1 in
    verify)
        verify
        ;;
    skool)
        shift
        skool "$@"
        ;;
    *)
        echo "Error: Unknown command '$1'"
        show_help
        exit 1
        ;;
esac
