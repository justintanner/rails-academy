#!/bin/bash

# ra - A CLI tool for Rails Academy

function show_help() {
    echo "Usage: ra [command] [arguments]"
    echo ""
    echo "Commands:"
    echo "  details             Show details about current Rails Academy config."
    echo "  skool @username     Register your skool username so that you can save you progress and more."
    echo "  update              Update Rails Academy to the latest version."
    echo "  verify              Verify your setup."
}

function update() {
    echo "Updating Rails Academy..."

    if [ -d "$RAILS_ACADEMY_PATH" ]; then
        cd $RAILS_ACADEMY_PATH || exit 1
        git pull
    else
        echo "Error: Rails Academy is not installed."
        please_reinstall_message
    fi
}

function please_reinstall_message() {
  echo "Please reinstall Rails Academy. Run the following command:"
  echo "curl -fsSL https://rails.academy/install | bash"
  exit 1
}

function update_config() {
    local variable="$1"
    local value="$2"

    CONFIG_FILE=~/.config/rails-academy/variables

    if grep -q "^export $variable=" "$CONFIG_FILE"; then
        # Update the variable if it exists
        sed -i '' "s|^export $variable=.*|export $variable=\"$value\"|" "$CONFIG_FILE"
    else
        # Add the variable if it doesn't exist
        echo "export $variable=\"$value\"" >> "$CONFIG_FILE"
    fi

    echo "Updated $variable to \"$value\""
    source "$CONFIG_FILE"
}

function verify_skool_username() {
  local username="$1"
  response=$(curl -s -o /dev/null -w "%{http_code}" "https://api.rails.academy/query?skool=$username")
  if [ "$response" -eq 200 ]; then
    update_config "RA_SKOOL" "$username"
    echo "Successfully registered $username"
  else
    echo "Error: Could not find user $username. Please try again later"
    exit 1
  fi
}

function verify() {
    echo "Verifying setup..."

    apps=("git" "gh" "mise" "kamal" "rails" "ruby" "docker" "grep")

    for app in "${apps[@]}"; do
        if ! command -v $app &> /dev/null; then
            echo "Error: $app is not installed."
            please_reinstall_message
        fi
    done

    if ! docker info &> /dev/null; then
        echo "Error: Docker is not running."
        echo "Please launch Docker and try again."
        exit 1
    fi
}

function skool() {
    if [ -z "$1" ]; then
        echo "Error: No username provided."
        echo "Usage: ra skool @username"
        exit 1
    fi

    username=$(echo "$1" | xargs)

    if [[ "$username" != @* ]]; then
        echo "Error: Username must start with '@'."
        exit 1
    fi

    # For now just storing the username in the env.
    update_config "RA_SKOOL" "$username"
    #verify_skool_username "$1"
    echo "Successfully registered $username"
}

function details() {
    echo "Rails Academy Details:"
    echo "  Path:           $RAILS_ACADEMY_PATH"
    echo "  Skool Username: $RA_SKOOL"
    verify
}

if [ $# -eq 0 ]; then
    show_help
    exit 0
fi

case $1 in
    details)
        details
        ;;
    upgrade)
        update
        ;;
    update)
        update
        ;;
    verify)
        verify
        ;;
    skool)
        shift
        skool "$@"
        ;;
    *)
        echo "Error: Unknown command '$1'"
        show_help
        exit 1
        ;;
esac
