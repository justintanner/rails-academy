#!/usr/bin/env bash

# ra - A CLI tool for Rails Academy

function show_help() {
    echo "Usage: ra [command] [arguments]"
    echo ""
    echo "Commands:"
    echo "  details             Show details about current Rails Academy config."
    echo "  light               Switch to the light color theme."
    echo "  dark                Switch to the dark color theme."
    echo "  update              Update Rails Academy to the latest version."
    echo "  verify              Verify your setup."
}

function update() {
    echo "Updating Rails Academy..."

    if [ -d "$RAILS_ACADEMY_PATH" ]; then
        cd $RAILS_ACADEMY_PATH || exit 1
        git pull
        echo "Please restart your terminal to apply the changes."
    else
        echo "Error: Rails Academy is not installed."
        please_reinstall_message
    fi
}

function please_reinstall_message() {
  echo "Please reinstall Rails Academy. Run the following command:"
  echo "curl -fsSL https://rails.academy/install | bash"
  exit 1
}

function help {
  echo "usage: app_cli <login | help>"
}

function theme() {
    if [ -z "$1" ]; then
        echo "Error: Please provide a theme name."
        exit 1
    fi

    ALACRITTY_CONFIG_FILE=~/.alacritty.toml

    if [ -d /mnt/c/Users ]; then
        windows_username=$(echo $PATH | grep -oP '/mnt/c/Users/\K[^/]+')
        WINDOWS_ALACRITTY_PATH="/mnt/c/Users/$windows_username/AppData/Roaming/alacritty"
        ALACRITTY_CONFIG_FILE="$WINDOWS_ALACRITTY_PATH/alacritty.toml"
        mkdir -p $WINDOWS_ALACRITTY_PATH
        cp ~/.local/share/rails-academy/common/themes/$1.toml $WINDOWS_ALACRITTY_PATH
        theme_file="$WINDOWS_ALACRITTY_PATH/$1.toml"
    else
        # eval is avoiding using $HOME because some platform doesn't support it.
        theme_file="$(eval echo ~/.local/share/rails-academy/common/themes/$1.toml)"
    fi

    if [ ! -f "$theme_file" ]; then
        echo "Error: Theme '$1' not found."
        exit 1
    fi

    # Modify ~/.alacritty.toml's import line to include the new theme file
    sed -i -E "s|^import = \[\".*\"\]|import = [\"$theme_file\"]|" $ALACRITTY_CONFIG_FILE
}

function light() {
    theme "light"
}

function dark() {
    theme "dark"
}

function verify() {
    apps=("git" "gh" "mise" "kamal" "rails" "ruby" "docker" "grep")

    for app in "${apps[@]}"; do
        if ! command -v $app &> /dev/null; then
            echo "Error: $app is not installed."
            please_reinstall_message
        fi
    done

    if ! docker info &> /dev/null; then
        echo "Error: Docker is not running."
        echo "Please launch Docker and try again."
        exit 1
    fi
}

function current_theme() {
    grep 'import' ~/.alacritty.toml | sed -E 's|import = \[".*/(.*)\.toml"\]|\1|'
}

function details() {
    echo "Rails Academy Details:"
    echo "    Version: ${RAILS_ACADEMY_VERSION:-Unknown}"
    echo "   Platform: $(uname -s | sed 's/_NT-.*$/_WSL/')"
    echo "Color Theme: $(current_theme)"
    echo -e "\n"
    verify
}

if [ $# -eq 0 ]; then
    show_help
    exit 0
fi

case $1 in
    details)
        details
        ;;
    light)
        light
        ;;
    dark)
        dark
        ;;
    themes)
        themes
        ;;
    theme)
        theme $2
        ;;
    upgrade)
        update
        ;;
    update)
        update
        ;;
    verify)
        echo "Verifying setup..."
        verify
        ;;
    *)
        echo "Error: Unknown command '$1'"
        show_help
        exit 1
        ;;
esac
